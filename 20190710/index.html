<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Hello Japan Search</title>
  <style>
    code {
      background: orange;
      color: navy;
      font-size: small;
      margin-left: 0.5em;
    }
  </style>
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script>
    const tighten = (a) => {
      const b = {};
      Object.keys(a).forEach(k => {
        b[k] = a[k].value;
      });
      return b;
    };

    const jps = sparql => fetch('https://jpsearch.go.jp/rdf/sparql?query=' + encodeURIComponent(sparql), {
        headers: {
          'Accept': 'application/sparql-results+json'
        }
      })
      .then(a => a.ok ? a.json() : null)
      .then(a => a === null ? [] : a.results.bindings.map(tighten));
  </script>
</head>

<body>
  <div id="left" style="position:absolute;top:0;left:0;width:50%;height:100%;overflow-y:scroll">
    <ul id="root"></ul>
  </div>
  <div id="right" style="position:absolute;top:0;right:0;width:50%;height:100%;overflow-y:scroll">
    <p id="status">hello</p>
    <table id="table">
      <thead>
        <tr>
          <th>#</th>
          <th>spatial</th>
          <th>temporal</th>
          <th>count</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>
  <script>
    fetch("data.json").then(a => a.json()).then(a => a.results.bindings.map(tighten)).then(all => {
      all.forEach(parent => {
        parent.children = all.filter(child => child.p === parent.s);
      });
      const dig = function(data) {
        const li = $("<li/>");
        if (parseInt(data.count) === 0) {
          li.append($("<span/>").text(data.label));
        } else {
          li.append($("<a/>", {
            href: data.s,
            "class": "type",
            target: "_blank"
          }).text(data.label));
          li.append($("<code/>").text(data.count));
        }
        if (data.children && data.children.length > 0) {
          const ul = $("<ul/>").appendTo(li);
          ul.append(data.children.map(c => dig(c)));
        }
        return li;
      };
      console.log(all.filter(root => root.p === undefined));
      all.filter(root => root.p === undefined).forEach(root => {
        $("#root").append(dig(root));
      });
    });

    $("#root").on("click", "a.type", function(e) {
      const now = new Date().getTime();
      $("#status").text("Now loading");
      const type = $(this).attr("href");

      jps(`SELECT ?p ?t (count(?s) as ?count) WHERE {
{?s a <${type}> ; schema:spatial  ?p ; schema:temporal ?t.}
union
{BIND (<https://jpsearch.go.jp/entity/time/_x_undefined> as ?t)
?s a <${type}> ; schema:spatial  ?p . filter not exists {?s schema:temporal ?x}}
union
{BIND (<https://jpsearch.go.jp/entity/place/_x_undefined> as ?p)
?s a <${type}> ; schema:temporal ?t . filter not exists {?s schema:spatial ?x}}
union
{
{BIND (<https://jpsearch.go.jp/entity/time/_x_undefined> as ?t)
BIND (<https://jpsearch.go.jp/entity/place/_x_undefined> as ?p)
?s a <${type}> .
filter not exists {?s schema:spatial ?x}}
filter not exists {?s schema:temporal ?x}}
} group by ?p ?t
`).then(json => {
        json.sort((a, b) => b.count - a.count);
        $("#status").text("Done in " + ((new Date().getTime() - now) / 1000) + "[sec]");
        $("tbody").empty();
        json.forEach((a, i) => {
          const tr = $("<tr/>");
          tr.append($("<th/>").text(i + 1));
          tr.append($("<td/>").text(a.p.split("/").pop()));
          tr.append($("<td/>").text(a.t.split("/").pop()));
          tr.append($("<td/>").text(a.count));
          $("tbody").append(tr);
        });
      });

      return false;
    });
  </script>
</body>

</html>
